<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚ªãƒ¼ãƒ€ãƒ¼ç®¡ç†ç”»é¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .login-icon {
            text-align: center;
            font-size: 60px;
            margin-bottom: 20px;
        }

        .login-title {
            text-align: center;
            font-size: 24px;
            color: #333;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:active {
            transform: scale(0.98);
        }

        .error-message {
            color: #f44336;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .main-app {
            display: none;
        }

        .main-app.active {
            display: block;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .logout-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:active {
            transform: scale(0.95);
        }

        h1 {
            font-size: 24px;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 12px;
            font-size: 14px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
        }

        .stat-number {
            font-size: 20px;
            font-weight: bold;
            margin-left: 5px;
        }

        .controls {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }

        .control-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn.active {
            background: #667eea;
            color: white;
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .orders-container {
            padding: 15px;
            padding-bottom: 100px;
        }

        .order-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
        }

        .order-card.preparing {
            border-left-color: #ffa500;
        }

        .order-card.ready {
            border-left-color: #00c853;
        }

        .order-card.completed {
            border-left-color: #999;
            opacity: 0.7;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        .order-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .order-time {
            font-size: 13px;
            color: #666;
        }

        .order-items {
            margin-bottom: 15px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 15px;
        }

        .item-name-qty {
            color: #333;
            font-weight: 500;
        }

        .item-price {
            color: #666;
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-top: 2px solid #f0f0f0;
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .total-amount {
            color: #667eea;
        }

        .order-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .btn-preparing {
            background: #ffa500;
            color: white;
        }

        .btn-ready {
            background: #00c853;
            color: white;
        }

        .btn-complete {
            background: #999;
            color: white;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .empty-text {
            font-size: 16px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .badge-pending {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-preparing {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge-ready {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-completed {
            background: #f5f5f5;
            color: #666;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .bottom-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .bottom-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-refresh {
            background: #667eea;
            color: white;
        }

        .btn-summary {
            background: #00c853;
            color: white;
        }

        .btn-csv {
            background: #ff9800;
            color: white;
        }

        .btn-spreadsheet {
            background: #4caf50;
            color: white;
        }

        .btn-clear-all {
            background: #f44336;
            color: white;
        }

        .btn-refresh:active,
        .btn-summary:active,
        .btn-csv:active,
        .btn-spreadsheet:active,
        .btn-clear-all:active {
            transform: scale(0.95);
        }

        .notification-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #f44336;
            border-radius: 50%;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .menu-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .menu-modal.active {
            display: block;
        }

        .menu-content {
            background: white;
            margin: 20px;
            margin-bottom: 100px;
            border-radius: 20px;
            padding: 25px;
            animation: slideUp 0.3s ease;
        }

        .menu-list {
            margin-bottom: 20px;
        }

        .menu-edit-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .menu-edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .menu-edit-category {
            font-size: 12px;
            color: #667eea;
            font-weight: bold;
        }

        .delete-menu-btn {
            padding: 6px 12px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delete-menu-btn:active {
            transform: scale(0.95);
        }

        .menu-edit-fields {
            display: grid;
            gap: 10px;
        }

        .edit-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .edit-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .edit-input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .edit-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .add-menu-section {
            background: #f0f4ff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .add-menu-title {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
        }

        .add-menu-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .add-menu-btn:active {
            transform: scale(0.98);
        }

        .save-menu-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #00c853 0%, #00e676 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
        }

        .save-menu-btn:active {
            transform: scale(0.98);
        }

        .category-select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            background: white;
        }

        /* é›†è¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« */
        .summary-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .summary-modal.active {
            display: block;
        }

        .summary-content {
            background: white;
            margin: 20px;
            margin-bottom: 100px;
            border-radius: 20px;
            padding: 25px;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .summary-title {
            font-size: 22px;
            font-weight: bold;
            color: #333;
        }

        .close-btn {
            width: 35px;
            height: 35px;
            border: none;
            background: #f0f0f0;
            color: #666;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .close-btn:active {
            transform: scale(0.9);
        }

        .summary-section {
            margin-bottom: 25px;
        }

        .summary-section-title {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 12px;
            padding-left: 10px;
            border-left: 4px solid #667eea;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            color: #666;
            font-size: 15px;
        }

        .summary-value {
            font-weight: bold;
            color: #333;
            font-size: 15px;
        }

        .summary-total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .summary-total-label {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .summary-total-value {
            font-size: 32px;
            font-weight: bold;
        }

        .summary-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.8;
            color: #333;
            font-family: monospace;
        }

        .copy-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.2s;
        }

        .copy-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-icon">ğŸ”</div>
            <div class="login-title">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</div>
            <form id="loginForm">
                <div class="input-group">
                    <label class="input-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" class="input-field" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <div class="error-message" id="errorMessage">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</div>
            </form>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div class="main-app" id="mainApp">
    <div class="header">
        <div class="header-top">
            <h1>ğŸ“‹ ã‚ªãƒ¼ãƒ€ãƒ¼ç®¡ç†</h1>
            <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        <div class="stats">
            <div class="stat-item">
                å¾…æ©Ÿä¸­ <span class="stat-number" id="pendingCount">0</span>
            </div>
            <div class="stat-item">
                èª¿ç†ä¸­ <span class="stat-number" id="preparingCount">0</span>
            </div>
            <div class="stat-item">
                å®Œæˆ <span class="stat-number" id="readyCount">0</span>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="control-btn active" data-filter="all">å…¨ã¦</button>
        <button class="control-btn" data-filter="pending">å¾…æ©Ÿä¸­</button>
        <button class="control-btn" data-filter="preparing">èª¿ç†ä¸­</button>
        <button class="control-btn" data-filter="ready">å®Œæˆ</button>
    </div>

    <div class="orders-container" id="ordersContainer">
        <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <div class="empty-text">ç¾åœ¨ã‚ªãƒ¼ãƒ€ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“</div>
        </div>
    </div>

    <div class="bottom-bar">
        <div class="bottom-buttons">
            <button class="bottom-btn btn-refresh" onclick="refreshOrders()">ğŸ”„ æ›´æ–°</button>
            <button class="bottom-btn btn-summary" onclick="showSummary()">ğŸ“Š é›†è¨ˆ</button>
        </div>
        <div class="bottom-buttons">
            <button class="bottom-btn btn-csv" onclick="downloadCSV()">ğŸ“¥ CSV</button>
            <button class="bottom-btn btn-spreadsheet" onclick="openSpreadsheet()">ğŸ“„ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ</button>
        </div>
        <div class="bottom-buttons">
            <button class="bottom-btn btn-clear-all" onclick="clearCompleted()">ğŸ—‘ï¸ å®Œäº†å‰Šé™¤</button>
        </div>
    </div>

    <!-- é›†è¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="summary-modal" id="summaryModal">
        <div class="summary-content">
            <div class="summary-header">
                <div class="summary-title">æœ¬æ—¥ã®é›†è¨ˆ</div>
                <button class="close-btn" onclick="closeSummary()">Ã—</button>
            </div>
            <div id="summaryBody"></div>
        </div>
    </div>

    </div>

    <script>
        // ========== Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºè¨­å®š ==========
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby6IsQE5MMgbEQE4Xr6Nu_QUkDQ5trFEJBszbXuxlJQqQ7-VbdJgjW8WXdJXHR61ePi/exec';
        
        // Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        async function fetchOrders() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getOrders&_=${Date.now()}`);
                const data = await response.json();
                return data.orders || [];
            } catch (error) {
                console.error('æ³¨æ–‡å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return [];
            }
        }
        
        // Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        async function updateOrderStatus(orderNumber, status) {
            try {
                console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°:', orderNumber, status);
                const response = await fetch(`${SCRIPT_URL}?action=updateOrder`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ number: orderNumber, status: status })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);
                
                if (result.success) {
                    console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°å®Œäº†');
                    return true;
                } else {
                    console.error('æ›´æ–°å¤±æ•—:', result.error);
                    return false;
                }
            } catch (error) {
                console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }
        
        // Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å–å¾—
        async function fetchMenu() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getMenu&_=${Date.now()}`);
                const data = await response.json();
                return data.menuItems || [];
            } catch (error) {
                console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return [];
            }
        }
        
        // Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ›´æ–°
        // ========== Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºè¨­å®šã“ã“ã¾ã§ ==========
        
        const ADMIN_PASSWORD = '12345678';
        let currentFilter = 'all';
        let autoRefresh = null;

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã
        function openSpreadsheet() {
            const spreadsheetUrl = 'https://docs.google.com/spreadsheets/d/170A7eiI4K9ERjVyJsVRcxz7u0u-to1LANg5XwJUhygc/edit';
            window.open(spreadsheetUrl, '_blank');
        }


        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('passwordInput').value;
            const errorMessage = document.getElementById('errorMessage');

            if (password === ADMIN_PASSWORD) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainApp').classList.add('active');
                sessionStorage.setItem('adminLoggedIn', 'true');
                renderOrders();
                startAutoRefresh();
            } else {
                errorMessage.classList.add('show');
                setTimeout(() => {
                    errorMessage.classList.remove('show');
                }, 3000);
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                sessionStorage.removeItem('adminLoggedIn');
                stopAutoRefresh();
                location.reload();
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
        window.addEventListener('load', () => {
            if (sessionStorage.getItem('adminLoggedIn') === 'true') {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainApp').classList.add('active');
                renderOrders();
                startAutoRefresh();
            }
        });

        // LocalStorageã‹ã‚‰æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        async function updateOrderStatusAndRefresh(orderNumber, newStatus) {
            const success = await updateOrderStatus(orderNumber, newStatus);
            if (success) {
                await renderOrders();
            }
        }

        async function deleteOrder(orderNumber) {
            alert('å‰Šé™¤æ©Ÿèƒ½ã¯ç¾åœ¨ã€Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç‰ˆã§ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ç›´æ¥å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚');
            // TODO: Apps Scriptã«å‰Šé™¤APIã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
        }

        async function clearCompleted() {
            alert('ä¸€æ‹¬å‰Šé™¤æ©Ÿèƒ½ã¯ç¾åœ¨ã€Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç‰ˆã§ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ç›´æ¥å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚');
            // TODO: Apps Scriptã«ä¸€æ‹¬å‰Šé™¤APIã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        function isToday(timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            return date.getFullYear() === today.getFullYear() &&
                   date.getMonth() === today.getMonth() &&
                   date.getDate() === today.getDate();
        }

        function getStatusBadge(status) {
            const badges = {
                pending: '<span class="status-badge badge-pending">å¾…æ©Ÿä¸­</span>',
                preparing: '<span class="status-badge badge-preparing">èª¿ç†ä¸­</span>',
                ready: '<span class="status-badge badge-ready">å®Œæˆ</span>',
                completed: '<span class="status-badge badge-completed">å®Œäº†</span>'
            };
            return badges[status] || '';
        }

        function getActionButtons(order) {
            const status = order.status;
            let buttons = '';

            if (status === 'pending') {
                buttons = `
                    <button class="action-btn btn-preparing" onclick="updateOrderStatusAndRefresh(${order.number}, 'preparing')">
                        èª¿ç†é–‹å§‹
                    </button>
                `;
            } else if (status === 'preparing') {
                buttons = `
                    <button class="action-btn btn-ready" onclick="updateOrderStatusAndRefresh(${order.number}, 'ready')">
                        å®Œæˆ
                    </button>
                `;
            } else if (status === 'ready') {
                buttons = `
                    <button class="action-btn btn-complete" onclick="updateOrderStatusAndRefresh(${order.number}, 'completed')">
                        æä¾›å®Œäº†
                    </button>
                `;
            }

            buttons += `
                <button class="action-btn btn-delete" onclick="deleteOrder(${order.number})">
                    å‰Šé™¤
                </button>
            `;

            return buttons;
        }

        async function renderOrders() {
            const container = document.getElementById('ordersContainer');
            const orders = await fetchOrders();
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const filteredOrders = currentFilter === 'all' 
                ? orders 
                : orders.filter(o => o.status === currentFilter);

            // çµ±è¨ˆæ›´æ–°
            const stats = {
                pending: orders.filter(o => o.status === 'pending').length,
                preparing: orders.filter(o => o.status === 'preparing').length,
                ready: orders.filter(o => o.status === 'ready').length
            };

            document.getElementById('pendingCount').textContent = stats.pending;
            document.getElementById('preparingCount').textContent = stats.preparing;
            document.getElementById('readyCount').textContent = stats.ready;

            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div class="empty-text">ç¾åœ¨ã‚ªãƒ¼ãƒ€ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                    </div>
                `;
                return;
            }

            // æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
            filteredOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            let html = '';
            filteredOrders.forEach(order => {
                let itemsHtml = '';
                for (const [id, item] of Object.entries(order.items)) {
                    const subtotal = item.price * item.quantity;
                    itemsHtml += `
                        <div class="order-item">
                            <span class="item-name-qty">${item.name} Ã— ${item.quantity}</span>
                            <span class="item-price">Â¥${subtotal.toLocaleString()}</span>
                        </div>
                    `;
                }

                html += `
                    <div class="order-card ${order.status}">
                        <div class="order-header">
                            <div>
                                <span class="order-number">#${String(order.number).padStart(3, '0')}</span>
                                ${getStatusBadge(order.status)}
                            </div>
                            <div class="order-time">${formatTime(order.timestamp)}</div>
                        </div>
                        <div class="order-items">
                            ${itemsHtml}
                        </div>
                        <div class="order-total">
                            <span>åˆè¨ˆ</span>
                            <span class="total-amount">Â¥${order.total.toLocaleString()}</span>
                        </div>
                        <div class="order-actions">
                            ${getActionButtons(order)}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function refreshOrders() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'ğŸ”„ æ›´æ–°ä¸­...';
            
            await renderOrders();
            
            setTimeout(() => {
                btn.textContent = originalText;
            }, 500);
        }

        // é›†è¨ˆè¡¨ç¤º
        async function showSummary() {
            const orders = await fetchOrders();
            const todayOrders = orders.filter(o => isToday(o.timestamp));

            if (todayOrders.length === 0) {
                alert('æœ¬æ—¥ã®ã‚ªãƒ¼ãƒ€ãƒ¼ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // å•†å“åˆ¥é›†è¨ˆ
            const itemSummary = {};
            todayOrders.forEach(order => {
                // order.itemsã¯é…åˆ—å½¢å¼ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹
                if (Array.isArray(order.items)) {
                    order.items.forEach(item => {
                        if (!itemSummary[item.name]) {
                            itemSummary[item.name] = { quantity: 0, amount: 0 };
                        }
                        itemSummary[item.name].quantity += item.quantity;
                        itemSummary[item.name].amount += item.price * item.quantity;
                    });
                } else {
                    // æ—§å½¢å¼ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼ï¼‰ã¸ã®å¯¾å¿œ
                    for (const [id, item] of Object.entries(order.items)) {
                        if (!itemSummary[item.name]) {
                            itemSummary[item.name] = { quantity: 0, amount: 0 };
                        }
                        itemSummary[item.name].quantity += item.quantity;
                        itemSummary[item.name].amount += item.price * item.quantity;
                    }
                }
            });

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥é›†è¨ˆ
            const statusSummary = {
                pending: todayOrders.filter(o => o.status === 'pending').length,
                preparing: todayOrders.filter(o => o.status === 'preparing').length,
                ready: todayOrders.filter(o => o.status === 'ready').length,
                completed: todayOrders.filter(o => o.status === 'completed').length
            };

            // ç·å£²ä¸Š
            const totalAmount = todayOrders.reduce((sum, order) => sum + order.total, 0);

            // ãƒ†ã‚­ã‚¹ãƒˆã‚µãƒãƒªãƒ¼ä½œæˆ
            const today = new Date();
            const dateStr = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
            
            let summaryText = `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            summaryText += `æœ¬æ—¥ã®å£²ä¸Šé›†è¨ˆ\n`;
            summaryText += `${dateStr}\n`;
            summaryText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
            
            summaryText += `ã€æ³¨æ–‡ä»¶æ•°ã€‘\n`;
            summaryText += `ç·ä»¶æ•°: ${todayOrders.length}ä»¶\n`;
            summaryText += `å¾…æ©Ÿä¸­: ${statusSummary.pending}ä»¶\n`;
            summaryText += `èª¿ç†ä¸­: ${statusSummary.preparing}ä»¶\n`;
            summaryText += `å®Œæˆ: ${statusSummary.ready}ä»¶\n`;
            summaryText += `å®Œäº†: ${statusSummary.completed}ä»¶\n\n`;
            
            summaryText += `ã€å•†å“åˆ¥è²©å£²æ•°ã€‘\n`;
            Object.entries(itemSummary)
                .sort((a, b) => b[1].quantity - a[1].quantity)
                .forEach(([name, data]) => {
                    summaryText += `${name}: ${data.quantity}å€‹ (Â¥${data.amount.toLocaleString()})\n`;
                });
            
            summaryText += `\nã€ç·å£²ä¸Šã€‘\n`;
            summaryText += `Â¥${totalAmount.toLocaleString()}\n`;
            summaryText += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            let html = '';
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥
            html += `<div class="summary-section">`;
            html += `<div class="summary-section-title">æ³¨æ–‡çŠ¶æ³</div>`;
            html += `<div class="summary-item"><span class="summary-label">ç·ä»¶æ•°</span><span class="summary-value">${todayOrders.length}ä»¶</span></div>`;
            html += `<div class="summary-item"><span class="summary-label">å¾…æ©Ÿä¸­</span><span class="summary-value">${statusSummary.pending}ä»¶</span></div>`;
            html += `<div class="summary-item"><span class="summary-label">èª¿ç†ä¸­</span><span class="summary-value">${statusSummary.preparing}ä»¶</span></div>`;
            html += `<div class="summary-item"><span class="summary-label">å®Œæˆ</span><span class="summary-value">${statusSummary.ready}ä»¶</span></div>`;
            html += `<div class="summary-item"><span class="summary-label">å®Œäº†</span><span class="summary-value">${statusSummary.completed}ä»¶</span></div>`;
            html += `</div>`;

            // å•†å“åˆ¥
            html += `<div class="summary-section">`;
            html += `<div class="summary-section-title">å•†å“åˆ¥è²©å£²æ•°</div>`;
            Object.entries(itemSummary)
                .sort((a, b) => b[1].quantity - a[1].quantity)
                .forEach(([name, data]) => {
                    html += `<div class="summary-item">`;
                    html += `<span class="summary-label">${name}</span>`;
                    html += `<span class="summary-value">${data.quantity}å€‹ (Â¥${data.amount.toLocaleString()})</span>`;
                    html += `</div>`;
                });
            html += `</div>`;

            // ç·å£²ä¸Š
            html += `<div class="summary-total">`;
            html += `<div class="summary-total-label">æœ¬æ—¥ã®ç·å£²ä¸Š</div>`;
            html += `<div class="summary-total-value">Â¥${totalAmount.toLocaleString()}</div>`;
            html += `</div>`;

            // ãƒ†ã‚­ã‚¹ãƒˆã‚µãƒãƒªãƒ¼
            html += `<div class="summary-text">${summaryText}</div>`;
            html += `<button class="copy-btn" onclick="copySummaryText()">ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>`;

            document.getElementById('summaryBody').innerHTML = html;
            document.getElementById('summaryModal').classList.add('active');

            // ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
            window.currentSummaryText = summaryText;
        }

        function closeSummary() {
            document.getElementById('summaryModal').classList.remove('active');
        }

        function copySummaryText() {
            navigator.clipboard.writeText(window.currentSummaryText).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        // CSVå‡ºåŠ›
        async function downloadCSV() {
            const orders = await fetchOrders();
            const todayOrders = orders.filter(o => isToday(o.timestamp));

            if (todayOrders.length === 0) {
                alert('æœ¬æ—¥ã®ã‚ªãƒ¼ãƒ€ãƒ¼ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // CSVãƒ˜ãƒƒãƒ€ãƒ¼
            let csv = 'æ³¨æ–‡ç•ªå·,æ—¥æ™‚,ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹,å•†å“å,æ•°é‡,å˜ä¾¡,å°è¨ˆ,åˆè¨ˆ\n';

            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            todayOrders.forEach(order => {
                const dateTime = new Date(order.timestamp);
                const dateStr = formatDate(order.timestamp);
                const timeStr = formatTime(order.timestamp);
                const status = {
                    pending: 'å¾…æ©Ÿä¸­',
                    preparing: 'èª¿ç†ä¸­',
                    ready: 'å®Œæˆ',
                    completed: 'å®Œäº†'
                }[order.status];

                // order.itemsã¯é…åˆ—å½¢å¼
                const items = Array.isArray(order.items) ? order.items : Object.values(order.items);
                items.forEach((item, index) => {
                    const subtotal = item.price * item.quantity;
                    csv += `${order.number},`;
                    csv += `${dateStr} ${timeStr},`;
                    csv += `${status},`;
                    csv += `${item.name},`;
                    csv += `${item.quantity},`;
                    csv += `${item.price},`;
                    csv += `${subtotal},`;
                    csv += index === 0 ? `${order.total}\n` : '\n';
                });
            });

            // BOMä»˜ãUTF-8ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const today = new Date();
            const filename = `order_${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}.csv`;
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒœã‚¿ãƒ³
        document.querySelectorAll('.control-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderOrders();
            });
        });

        // è‡ªå‹•æ›´æ–°
        function startAutoRefresh() {
            autoRefresh = setInterval(async () => {
                await renderOrders();
            }, 3000);
        }

        function stopAutoRefresh() {
            if (autoRefresh) clearInterval(autoRefresh);
        }

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«è‡ªå‹•æ›´æ–°ã‚’åœæ­¢
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('summaryModal').addEventListener('click', (e) => {
            if (e.target.id === 'summaryModal') {
                closeSummary();
            }
        });

        document.getElementById('menuModal').addEventListener('click', (e) => {
            if (e.target.id === 'menuModal') {
                closeMenuEditor();
            }
        });
    </script>
</body>
</html>
